{% from "baseframe/components.html.jinja2" import faicon %}
{% from "baseframe/forms.html.jinja2" import renderfield %}

{% macro commenttree(comments, document, project, csrf_form) %}
{%- for comment in comments %}
  <li class="comment">
    <div id="c{{ comment.uuid_b58 }}">
      <div class="comment--content">
        <div class="comment--header">
          <button class="js-collapse mui-btn mui-btn--nostyle" aria-label="{% trans %}Hide comment{% endtrans %}" aria-expanded="true">
            {{ faicon(icon='caret-circle-up', icon_size='subhead') }}
          </button>
          <button class="js-uncollapse mui-btn mui-btn--nostyle mui--hide" aria-expanded="false" aria-label="{% trans %}Collapse comment{% endtrans %}">
            {{ faicon(icon='caret-circle-down', icon_size='subhead') }}
          </button>
          <div class="comment--header__details">
            {% if comment.state.DELETED -%}
              <span class="commenter">[{% trans %}deleted{% endtrans %}]</span>
            {%- else -%}
              <span class="commenter"><strong>{{ comment.user.pickername }}</strong></span>
              {%- if comment.user == document.user %}
                <span class="badge">Proposer</span>
              {% endif %}
              {%- if 'crew' in project.roles_for(comment.user) %}
                <span class="badge">Crew</span>
              {% endif %}
              <span class="mui--text-caption mui--text-accent">{{ comment.created_at|age }}</span>
              {%- if comment.edited_at %}
                <span class="mui--text-caption mui--text-accent">({% trans %}edited{% endtrans %} {{ comment.edited_at|age }})</span>
              {%- endif %}
            {%- endif %}
          </div>
        </div>
        <div class="comment--body">
          {% if not comment.state.DELETED -%}
            {{ comment.message }}
          {%- endif %}
          <div data-id="{{ comment.uuid_b58 }}" data-commentset-id="{{ comment.commentset.uuid_b58 }}" {% if comment.view_for('edit').is_available() %} data-delete-url="{{ comment.url_for('delete') }}" data-edit-url="{{ comment.url_for('edit') }}" {% endif %} data-json-url="{{ comment.url_for('view_json', _external=true) }}" class="comment--footer">
            {% if not comment.state.DELETED %}
              {% if current_auth %}<a aria-label="{% trans %}Reply{% endtrans %}" class="mui--text-menu mui--text-accent js-comment-reply" href="#c{{ comment.uuid_b58 }}" data-cy="reply">[Reply]</a>{% endif %}
              {% if comment.current_roles.author %}
                <a aria-label="{% trans %}Edit{% endtrans %}" class="mui--text-menu mui--text-accent js-comment-edit" href="#c{{ comment.uuid_b58 }}" data-cy="edit">{% trans %}[Edit]{% endtrans %}</a>
                <a aria-label="{% trans %}Delete{% endtrans %}" class="mui--text-menu mui--text-accent js-comment-delete" href="#c{{ comment.uuid_b58 }}" data-cy="delete">{% trans %}[Delete]{% endtrans %}</a>
              {%- endif %}
            {%- endif %}
            <a aria-label="Permalink" class="mui--text-menu mui--text-accent comment--permalink" href="#c{{ comment.uuid_b58 }}">[{% trans %}Link{% endtrans %}]</a>
            {% if comment.parent %}<a aria-label="{% trans %}Parent{% endtrans %}" class="mui--text-menu mui--text-accent comment--parent" href="#c{{ comment.parent.uuid_b58 }}">[{% trans %}Parent{% endtrans %}]</a>{% endif %}
            <span class="loading mui--hide"></span>
          </div>
        </div>
        {% if comment.children %}
          <ul class="mui-list--aligned mui-list--unstyled comment--children">
            {{ commenttree(comment.sorted_children(), document, project, csrf_form) }}
          </ul>
        {% endif %}
      </div>
    </div>
  </li>
{% endfor -%}
{% endmacro %}

{% macro commentformtemplate(parent, commentform, delcommentform, current_auth) %}
  {% if not current_auth.user -%}
    <p>
      <a class="mui-btn mui-btn--small mui-btn--raised mui-btn--primary" href="{{ url_for('login') }}" data-cy="login-btn">{% trans %}Login to leave a comment{% endtrans %}</a>
    </p>
  {% elif parent.features.comment_new() -%}
    <form method="POST" id="comment-form" action="{{ parent.commentset.url_for('new_comment') }}" class="mui-form comments-form">
      <div class="mui--hide">
        <input type="hidden" name="form.id" value="newcomment"/>
        {{ commentform.hidden_tag() }}
      </div>
      {{ renderfield(commentform.message, nolabel=true, css_class='message') }}
      {{ renderfield(commentform.recaptcha, nolabel=true, css_class='recaptcha-field') }}
      <input id="comment-submit" class="mui-btn mui-btn--small mui-btn--raised mui-btn--primary" type="submit" value="{% trans %}Post comment{% endtrans %}"/>
      <button id="comment-cancel" class="mui-btn mui-btn--small mui-btn--raised mui-btn--accent mui--hide" href="#">{% trans %}Cancel{% endtrans %}</button>
    </form>
    <p id="toplevel-comment" class="mui--hide">
      <a href="#">{% trans %}Post a comment &rarr;{% endtrans %}</a>
    </p>
    <form method="POST" id="delcomment" class="mui--hide">
      <div class="mui--hide">
        <input type="hidden" name="form.id" value="delcomment"/>
        {{ delcommentform.hidden_tag() }}
        {{ delcommentform.comment_id() }}
      </div>
      <p>
        {% trans %}Delete this comment?{% endtrans %} <input id="comment-delete-submit" class="mui-btn mui-btn--small mui-btn--raised mui-btn--danger" type="submit" value="{% trans %}Delete{% endtrans %}" data-cy="delete-comment"/>
        <button id="comment-delete-cancel" class="mui-btn mui-btn--small mui-btn--raised mui-btn--accent" href="#">{% trans %}Cancel{% endtrans %}</button>
      </p>
    </form>
  {% else %}
    <p class="mui-panel mui--bg-accent">You need to be a participant to comment.</p>
  {% endif %}
{% endmacro %}
