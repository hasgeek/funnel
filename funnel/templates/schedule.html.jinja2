{% extends "layout.html.jinja2" %}
{% from "macros.html.jinja2" import project_header, admin_panel %}
{% block title %}{% trans %}Schedule{% endtrans %} &mdash; {{ project.title }}{% endblock %}

{%- macro page_btns(project) %}
  <ul class="mui-list--inline">
    {%- if project.boxoffice_data %}
      <li class="cta">
        <a href="#tickets" class="mui-btn mui-btn--raised mui-btn--primary">{% trans %}Participate{% endtrans %}</a>
      </li>
    {%- elif project.buy_tickets_url %}
      <li class="cta">
        <a href="{{ project.buy_tickets_url }}" class="mui-btn mui-btn--raised mui-btn--primary" target="_blank">{% trans %}Participate{% endtrans %}</a>
      </li>
    {%- endif %}
    <li>
      <a href="{{ project.url_for('subscribe_schedule') }}" class="mui-btn mui-btn--raised mui-btn--accent" rel="modal:open">{% trans %}Add to calendar{% endtrans %}</a>
    </li>
    <div id="popup_subscribe" class="modal">
    </div>
  </ul>
{%- endmacro %}

{%- macro subnavbar_items(project) %}
  <a class="sub-navbar__item mui--text-subhead" href="{{ project.url_for() }}#about">About</a>
  {%- if project.instructions -%}<a class="sub-navbar__item mui--text-subhead" href="#call-for-proposal">Call for proposals</a>{%- endif %}
  {%- if project.featured_sessions  %}<a class="sub-navbar__item mui--text-subhead" href="{{ project.url_for() }}#featured-talk">Featured talks</a>{%- endif %}
  {%- if project.sessions %}<a class="sub-navbar__item mui--text-subhead smooth-scroll" href="#schedule">Schedule</a>{%- endif %}
  {%- if project.hasjob_embed_url -%}<a class="sub-navbar__item mui--text-subhead" href="{{ project.url_for() }}#related-jobs">Jobs</a>{%- endif %}
  {%- if project.primary_venue -%}<a class="sub-navbar__item mui--text-subhead" href="{{ project.url_for() }}#venue">Venue</a>{%- endif %}
  {%- if project.proposals -%}<a class="sub-navbar__item mui--text-subhead" href="{{ project.url_for('view_proposals') }}#proposals">Proposals</a>{%- endif %}
  {%- if project.boxoffice_data or project.buy_tickets_url -%}<a class="mui-btn mui-btn--primary mui--hidden-xs mui--hidden-sm mui--hidden-md" {% if project.boxoffice_data -%} href="{{ project.url_for() }}#tickets" {%- elif project.buy_tickets_url %} href="{{ project.buy_tickets_url }}"{%- endif %}>Participate</a>{%- endif %}
{%- endmacro %}

{% block headline %}
  {{ project_header(project, page_btns=page_btns(project), subnavbar_items=subnavbar_items(project)) }}
{% endblock %}

{% block contentwrapper %}
  <div class="grid details-section">
    <div class="grid__col-xs-12 grid__col-md-5 grid__col-lg-4">
      {%- if project.current_roles.admin or 'checkin-event' in g.permissions %}
        {{ admin_panel(project, transition_form) }}
      {% endif %}
    </div>
  </div>

  <div class="grid" id="schedule">
    <div class="grid__col-xs-12">
      <div class="schedule-table-container" id="project-schedule-table">
        {% raw %}
          <script id="scheduletemplate" type="text/ractive">
            {{#schedules:schedule}}
              {{#schedule}}
                <div class="schedule">
                  <h2 class="mui--text-heading schedule__date">{{dateStr}}</h2>
                  <div class="mui--bg-accent">
                    <div class="schedule__row schedule__row--sticky">
                        <p class="schedule__row__column schedule__row__column--time schedule__row__column--time--header" style="min-width:{{timeSlotWidth}}px"><i class="material-icons mui--text-headline" style="position: relative;">schedule</i>
                        </p>
                      {{#rooms:room, roomindex}}
                        {{rooms.length}}
                        <div class="schedule__row__column schedule__row__column--header {{#if activeTab == room}}js-tab-active{{/if}}" style="width: calc(100% - {{getColumnWidth('header')}}px)" on-click="toggleTab(event, room)">{{title}}</div>
                      {{/}}
                    </div>
                    {{#sessions:session, index}}
                      <div class="schedule__row {{#if hasActiveRoom(sessions[session])}}js-active{{/if}}" style="height: {{rowHeight}}px">
                        {{#if showLabel}}
                          <a href="#t{{session}}" id="t{{session}}" class="schedule__row__column schedule__row__column--time schedule__row__column--time--pointer" style="min-width:{{timeSlotWidth}}px" on-click="disableScroll(event)">{{ getTimeStr(session) }}</a>
                        {{else}}
                          <p class="schedule__row__column schedule__row__column--time" style="min-width:{{timeSlotWidth}}px"></p>
                        {{/if}}
                        {{#rooms:room, roomIndex}}
                          <div class="schedule__row__column {{#if talks}}schedule__row__column--talks {{room}}{{/if}} {{#if talks && activeTab == room}}js-active{{/if}}" style="width: {{#if width && getColumnWidth('content')}}calc(100% - {{getColumnWidth('content')}}px);{{else}} 100%;{{/if}}" on-click="showSessionModal(event)">
                            {{#if talks}}
                              <div class="schedule__row__column__content {{#if talks.description}}schedule__row__column__content--overflow{{/if}}" style="height: calc({{talks.duration}}*{{rowHeight}}px);" id="{{talks.url_name}}">
                                <div class="schedule__row__column__content__title">
                                  <p class="mui--text-caption schedule__row__column__content__title__duration">{{ getTimeStr(talks.startTime) }}â€“{{ getTimeStr(talks.endTime) }}</p>
                                  {{#if talks.title}}
                                    <p class="mui--text-subhead schedule__row__column__content__title__heading"><b>{{ talks.title }}</b></p>
                                  {{/if}}
                                  {{#if talks.speaker}}
                                    <p class="mui--text-caption mui--text-light">{{ talks.speaker }}</p>
                                  {{/if}}
                                </div>
                                {{#if talks.description}}
                                  <div class="schedule__row__column__content__decription mui--text-body1">{{{ removeImg(talks.description) }}}</div>
                                {{/if}}
                              </div>
                            {{/if}}
                          </div>
                        {{/}}
                      </div>
                    {{/}}
                  </div>
                </div>
              {{/}}
            {{/}}
            <div id="session-modal" class="session-modal">
              {{{modalHtml}}}
            </div>
          </script>
        {% endraw %}
      </div>
    </div>
  </div>
{% endblock %}

{% block footerscripts %}
  {% assets "js_ractive" -%}
    <script type="text/javascript" src="{{ ASSET_URL }}"></script>
  {%- endassets -%}
  <script type="text/javascript">
    var scheduleConfig = {
      fromDate: {{ from_date|tojson }},
      toDate: {{ to_date|tojson }},
      scheduled: {{ sessions|tojson }},
      rooms: {{ rooms|tojson }},
      slotInterval: 5,
      divElem: "#project-schedule-table",
      scriptTemplate: '#scheduletemplate',
    }
  </script>
  <script type="text/javascript">
    $(document).ready( function() {
      window.Talkfunnel.Schedule.init(scheduleConfig);
    });
  </script>
{% endblock %}
