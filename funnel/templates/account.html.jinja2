{% extends "layout.html.jinja2" %}
{% from "baseframe/mui/forms.html.jinja2" import rendersubmit, ajaxform %}
{% from "baseframe/components.html.jinja2" import faicon %}
{%- from "macros.html.jinja2" import account_tabs %}

{% block title %}{% trans %}My account{% endtrans %}{% endblock %}

{% block bodytag %}
  {%- if not config['LEGACY'] -%}
    <body class="mui--bg-primary hg-app tabs-navbar">
  {%- else %}
    <body class="mui--bg-primary">
  {%- endif %}
{% endblock %}

{% block headline -%}
  <div class="tabs-wrapper tabs-wrapper--sticky">
    <div class="mui-container">
      <div class="grid">
        <div class="grid__col-12">
          {{ account_tabs(active_tab='account') }}
        </div>
      </div>
    </div>
  </div>
{%- endblock %}

{% block basecontent %}
  <div class="mui-container tab-content">
    <div class="grid">
      <div class="grid__col-xs-12 grid__col-sm-6">
        <div class="card">
          <div class="card__header">
            <h3 class="mui--text-title mui--text-bold">Info</h3>
          </div>
          <div class="card__body card__body--lgtext">
            <p class="mui--text-subhead">
              {{ faicon(icon='address-card')}}&nbsp;&nbsp;{{ current_auth.user.fullname }}
            </p>
            <p class="mui--text-subhead">
              {{ faicon(icon='user') }}&nbsp;&nbsp;{% if current_auth.user.username %}<a href="{{ current_auth.user.profile.url_for() }}" class="mui--text-subhead" data-cy="my-profile">{{ current_auth.user.username }}</a>{% else %}<em>{% trans %}(none){% endtrans %}</em>{% endif %}
            </p>
            <p class="mui--text-subhead">
              {{ faicon('clock') }}&nbsp;&nbsp;{{ current_auth.user.timezone }}
            </p>
          </div>
          <div class="mui-divider"></div>
          <form action="{{ url_for('account_logout') }}" method="POST" id="logout-form">
            {{ logout_form.hidden_tag() }}
            <div class="card__footer card__footer--smallerbtn">
              <a class="mui-btn mui-btn--small mui-btn--flat mui-btn--primary" href="{{ url_for('account_edit') }}" data-cy="edit">{% trans %}Edit{% endtrans %}</a>
              <a class="mui-btn mui-btn--small mui-btn--flat mui-btn--accent" href="{{ url_for('change_password') }}" data-cy="change-password">{% trans %}Change password{% endtrans %}</a>
              <button class="mui-btn mui-btn--small mui-btn--flat mui-btn--accent" type="submit" data-cy="Logout">{% trans %}Logout{% endtrans %}</button>
            </div>
          </form>
        </div>
      </div>
      <div class="grid__col-xs-12 grid__col-sm-6">
        <div class="card">
          <div class="card__header">
            <h3 class="mui--text-title mui--text-bold">{% trans %}External IDs <small>(Use any of these to login to your account){% endtrans %}</small></h3>
          </div>
          <div class="card__body card__body--lgtext mui--text-subhead">
            <ol class="mui-list--aligned mui-list--border">
              {% for extid in current_auth.user.externalids %}
                <li>
                  {{ faicon(icon=extid.service, icon_size='body2', baseline=false, css_class='mui--text-light icon-img icon-img--smaller') }}<span class="item">{{ extid.username }}<small class="subitem"><em>{% trans %}Last used{% endtrans %} {{ extid.last_used_at|age }}</em></small></span>
                  <a href="{{ url_for('remove_extid', service=extid.service, userid=extid.userid) }}" class="mui--pull-right" title="{% trans %}Remove{% endtrans %}">{{ faicon(icon='trash-alt', icon_size='subhead', baseline=false, css_class='mui--align-middle') }}</a>
                </li>
              {% endfor %}
            </ol>
            <p>{% trans %}Add External ID{% endtrans %}</p>
            {% for provider in login_registry %}
              <a class="mui-btn mui-btn--small mui-btn--raised login login--smaller login-{{ provider }}" href="{{ url_for('login_service', service=provider, next=url_for('account')) }}" title="{{ login_registry[provider]['title'] }}"><img src="{{ url_for('static', filename='img/' + login_registry[provider].icon + '.svg') }}" class="icon-img icon-img--smaller" alt="{{ login_registry[provider]['title'] }}"/>{{ login_registry[provider]['title'] }}</a>
            {% endfor %}
          </div>
        </div>
      </div>

      {% with has_multiple_verified_contacts=(current_auth.user.verified_contact_count > 1) -%}
      <div class="grid__col-xs-12 grid__col-sm-6">
        <div class="card">
          <div class="card__header">
            <h3 class="mui--text-title mui--text-bold">{% trans %}Email addresses{% endtrans %}</h3>
          </div>
          <form action="{{ url_for('make_email_primary') }}" method="POST" id="email-primary-form">
            <div class="card__body card__body--lgtext mui--text-subhead">
              {{ primary_email_form.hidden_tag() }}
              <ol class="mui-list--aligned mui-list--border">
                {% for useremail in current_auth.user.views.emails_sorted() %}
                <li>
                  <input id="useremail-{{loop.index}}" name="email" value="{{useremail}}" type="radio" class="form-inline-input"><label for="useremail-{{loop.index}}" class="form-inline-label">{{ useremail }}{% if useremail.primary %} <span title="{% trans %}Primary{% endtrans %}" class="check-mark mui--align-middle">{{ faicon(icon='check', icon_size='caption', baseline=false) }}</span> {%- endif -%}
                  </label>
                  {%- if has_multiple_verified_contacts %}
                    <a href="{{ url_for('remove_email', email_hash=useremail.email_address.email_hash) }}" class="mui--pull-right" title="{% trans %}Remove{% endtrans %}">{{ faicon(icon='trash-alt', icon_size='subhead', baseline=false, css_class='mui--align-middle') }}</a>
                  {%- endif %}
                </li>
                {% endfor %}
                {% for useremail in current_auth.user.emailclaims %}
                <li>
                  <input type="radio" disabled="disabled" class="form-inline-input"><span class="form-inline-label">{{ useremail }} <em><a href="{{ url_for('verify_email', email_hash=useremail.email_address.email_hash) }}">{% trans %}(pending verification){% endtrans %}</a></em></span>
                  <a href="{{ url_for('remove_email', email_hash=useremail.email_address.email_hash) }}" title="{% trans %}Remove{% endtrans %}" class="mui--pull-right">{{ faicon(icon='trash-alt', icon_size='subhead', baseline=false, css_class='mui--align-middle') }}</a>
                </li>
                {% endfor %}
              </ol>
            </div>
            <div class="mui-divider"></div>
            <div class="card__footer card__footer--smallerbtn">
              {% if current_auth.user.emails %}
                <button class="mui-btn mui-btn--small mui-btn--flat mui-btn--primary" type="submit" title="Set as primary email">{% trans %}Set as primary{% endtrans %}</button>
              {% endif %}
              <a class="mui-btn mui-btn--small mui-btn--flat mui-btn--accent" href="{{ url_for('add_email') }}" title="Add an email address">{% trans %}Add an email address{% endtrans %}</a>
              <span class="loading mui--hide"></span>
            </div>
          </form>
        </div>
      </div>

      <div class="grid__col-xs-12 grid__col-sm-6">
        <div class="card">
          <div class="card__header">
            <h3 class="mui--text-title mui--text-bold">{% trans %}Mobile numbers{% endtrans %}</h3>
          </div>
          <form action="{{ url_for('make_phone_primary') }}" method="POST" id="phone-primary-form">
            <div class="card__body card__body--lgtext mui--text-subhead">
              {{ primary_phone_form.hidden_tag() }}
              <ol class="mui-list--aligned mui-list--border">
                {% for userphone in current_auth.user.views.phones_sorted() %}
                  <li>
                    <input id="userphone-{{loop.index}}" name="phone" value="{{userphone}}" type="radio">&nbsp;
                    <label for="userphone-{{loop.index}}">{{ userphone.formatted() }}</label>
                    {% if userphone.primary %} <span title="{% trans %}Primary{% endtrans %}" class="check-mark mui--align-middle">{{ faicon(icon='check', icon_size='caption', baseline=false) }}</span> {%- endif -%}
                    {%- if has_multiple_verified_contacts %}
                      <a href="{{ url_for('remove_phone', number=userphone.phone) }}" title="{% trans %}Remove{% endtrans %}" class="mui--pull-right">{{ faicon(icon='trash-alt', icon_size='subhead', baseline=false, css_class='mui--align-middle') }}</a>
                    {%- endif %}
                  </li>
                {% endfor %}
                {% for userphone in current_auth.user.phoneclaims %}
                  <li>
                    <input type="radio" disabled="disabled">&nbsp;
                    <label>{{ userphone.formatted() }}</label> <em>{% if userphone.verification_expired %}{% trans %}(blocked){% endtrans %}{% else %}<a href="{{ url_for('verify_phone', number=userphone) }}">{% trans %}(pending verification){% endtrans %}</a>{% endif %}</em>
                    {% if not userphone.verification_expired %}
                      <a href="{{ url_for('remove_phone', number=userphone.phone) }}" title="{% trans %}Remove{% endtrans %}" class="mui--pull-right">{{ faicon(icon='trash-alt', icon_size='subhead', baseline=false, css_class='mui--align-middle') }}</a>
                    {% endif %}
                  </li>
                {% endfor %}
              </ol>
            </div>
            <div class="mui-divider"></div>
            <div class="card__footer card__footer--smallerbtn">
              {% if current_auth.user.phones %}<button class="mui-btn mui-btn--small mui-btn--flat mui-btn--primary" type="submit">{% trans %}Set as primary{% endtrans %}</button>{% endif %}
              <a class="mui-btn mui-btn--small mui-btn--flat mui-btn--accent" href="{{ url_for('add_phone') }}">{% trans %}Add a mobile number{% endtrans %}</a>
              <span class="loading mui--hide"></span>
            </div>
          </form>
        </div>
      </div>
      {%- endwith %}

      <div class="grid__col-xs-12">
        <div class="card">
          <div class="card__header">
            <h3 class="mui--text-title mui--text-bold">{% trans %}Organizations{% endtrans %}</h3>
          </div>
          <div class="card__body">
            <ol class="mui-list--aligned mui-list--border">
              {% for org in current_auth.user.organizations_as_admin %}
              <li>
                <p class="mui--text-body2 separator">
                  <a href="{{ org.profile.url_for() }}" title="{% trans %}Open profile{% endtrans %}">{{ org.title }}</a>
                  {% if not org.profile.state.PUBLIC %}
                    <span class="mui--pull-right">{{ faicon(icon='lock-alt') }} {% trans %}Private{% endtrans %}</span>
                  {% endif %}
                </p>
              </li>
              {%- endfor %}
            </ol>
          </div>
        </div>
      </div>

      <div class="grid__col-xs-12">
        <div class="card">
          <div class="card__header">
            <h3 class="mui--text-title mui--text-bold">{% trans %}Login sessions{% endtrans %}</h3>
          </div>
          <form action="{{ url_for('account_logout') }}" method="POST" id="logout-session-form">
            {{ logout_form.hidden_tag() }}
            <div class="card__body">
              <ul class="mui-list--aligned mui-list--unstyled grid-no-left-padding mui-list--border">
                {%- for user_session in current_auth.user.active_sessions %}
                {%- with
                    ua=user_session.views.user_agent_details(),
                    login_service=user_session.views.login_service(),
                    location=user_session.views.location(),
                    user_agent=user_session.user_agent,
                    since=user_session.created_at|age,
                    last_active=user_session.accessed_at|age
                    %}
                  <li class="flex-wrapper flex-wrapper--baseline flex-wrapper--space-between login-session">
                    <div>
                      <p title="{{ user_agent }}" class="login-session__heading">{{ ua['browser'] }}<br class="mui--visible-xs-inline mui--visible-sm-inline" aria-hidden="true"><span class="mui--hidden-xs mui--hidden-sm interpunct" aria-hidden="true">&#8226;</span>{{ ua['os_device'] }}</p>
                      <p class="login-session__body mui--text-light">
                        {%- if login_service %}
                          {%- trans %}Since {{ since }} via {{ login_service }} – last active {{ last_active }}{% endtrans %}
                        {%- else %}
                          {%- trans %}Since {{ since }} – last active {{ last_active }}{% endtrans %}
                        {%- endif -%}
                      </p>
                      <p class="login-session__body mui--text-light">{% trans ipaddr=user_session.ipaddr %}{{ location }} – estimated from {{ ipaddr }}{% endtrans %}</p>
                    </div>
                    <div>
                      {%- if user_session == current_auth.session %}
                        <span title="{% trans %}Current{% endtrans %}" class="check-mark mui--align-bottom">{{ faicon(icon='check', icon_size='caption', baseline=false) }}</span>
                      {%- else %}
                        <button type="submit" name="sessionid" value="{{ user_session.buid }}" title="{% trans %}Logout{% endtrans %}" class="mui-btn mui-btn--small mui-btn--flat mui-btn--nostyle">{{ faicon(icon='trash-alt', icon_size='subhead', baseline=false, css_class='mui--align-middle mui--text-hyperlink') }}</button>
                      {%- endif -%}
                    </div>
                  </li>
                {%- endwith %}
                {%- endfor %}
              </ul>
            </div>
          </form>
        </div>
      </div>
    </div>
{% endblock %}

{% block footerscripts %}
  {{ ajaxform('email-primary-form', request) }}
  {{ ajaxform('phone-primary-form', request) }}
{% endblock %}
