{% extends "inc/layout.html" %}
{% from "baseframe/forms.html" import renderfield_bs3 %}
{% from "inc/comments.html" import commenttree %}
{% block title %}{{ proposal.title }} &mdash; {{ space.title }}{% endblock %}
{% block heading %}{# Inhibit display of page-level title #}{% endblock %}

{% block headline -%}{%- endblock %}

{% block content %}
{#<p style="margin-top: 0; font-size: 80%;">
  <a href="{{ url_for('viewspace', name=space.name) }}">&larr; Return to {{ space.title }}</a>
  {% if proposal.user == g.user %}| <a href="{{ url_for('editsession', name=space.name, slug=proposal.urlname) }}">Edit this &rarr;</a>{% endif %}
</p>#}
    
<div class="col-md-10 col-sm-10 col-xs-12 col-sm-push-1 col-md-push-1">
  <div class="infosheet">
  <div class="section first">
    <div class="votebox">
      {%- set vote = proposal.votes.getvote(g.user) %}
      <div class="choices">

        {%- if not vote %}
          <a class="votechoice" title="Vote up" href="{{ url_for('voteupsession', name=space.name, slug=proposal.urlname) }}">+1</a>
          <a class="votechoice" title="Vote down" href="{{ url_for('votedownsession', name=space.name, slug=proposal.urlname) }}">-1</a>
        {%- elif vote.votedown %}
          <a class="votechoice" title="Vote up" href="{{ url_for('voteupsession', name=space.name, slug=proposal.urlname) }}">+1</a>
          <a class="votechoice selected" title="Withdraw vote" href="{{ url_for('votecancelsession', name=space.name, slug=proposal.urlname) }}">-1</a>
        {%- else %}
          <a class="votechoice selected" title="Withdraw vote" href="{{ url_for('votecancelsession', name=space.name, slug=proposal.urlname) }}">+1</a>
          <a class="votechoice" title="Vote down" href="{{ url_for('votedownsession', name=space.name, slug=proposal.urlname) }}">-1</a>
        {% endif %}
        <span class="indicator">&rarr;</span>
        <span class="score">
          {%- if proposal.votes.count > 0 -%}
            +
          {%- endif -%}
          {{ proposal.votes.count }}</span>
        </div>
      <div class="label">
        Vote on this proposal
      </div>
    </div>
    <h1>{{ proposal.title }}</h1>
    <p>
      by <strong>{{ proposal.user.fullname }}</strong>
      {% if proposal.user == proposal.speaker -%}
        (speaking)
      {%- else -%}
        (proposing)
      {%- endif %}
      {% if proposal.user == g.user -%}
        <small>(that’s you! <a href="{{ url_for('editsession', name=space.name, slug=proposal.urlname) }}">Edit this</a>? <a href="{{ url_for('deletesession', name=space.name, slug=proposal.urlname) }}">Delete this</a>?)</small>
      {%- endif %}
    </p>
    <!-- Social buttons -->
    <div class="social">
      <a href="//twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="{{ config['TWITTER_ID'] }}">Tweet</a>
      <g:plusone size="medium"></g:plusone>
      <iframe class="facebooklike" src="//www.facebook.com/plugins/like.php?app_id=114496105304651&amp;href={{ request.url }}&amp;send=false&amp;layout=button_count&amp;width=150&amp;show_faces=false&amp;action=recommend&amp;colorscheme=light&amp;font&amp;height=21" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:150px; height:21px;" allowTransparency="true"></iframe>
      {% if 'siteadmin' in g.lastuserinfo.permissions %}
        <form method="POST" action="{{ url_for('confirmsession', name=space.name, slug=proposal.urlname) }}" style="float: right">
          {{ confirmform.hidden_tag() }}
          {% if proposal.confirmed -%}
            <button type="submit">Cancel Session</button>
          {% else %}
            <button type="submit">Confirm Session</button>
          {% endif -%}
        </form>
      {% endif %}
    </div>
  </div>
  <div class="section bar">
    <dl class="bar">
      {%- if proposal.section %}
        <dt>Section</dt>
        <dd>{{ proposal.section.title }}</dd>
        <br class="hide-desktop">
      {%- endif %}
      {%- if proposal.session_type %}
        <dt>Session type</dt>
        <dd>{{ proposal.session_type }}</dd>
        <br class="hide-desktop">
      {%- endif %}
      <dt>Technical level</dt>
      <dd>{{ proposal.technical_level }}</dd>
    </dl>
  </div>
  <div class="section">
    {%- if not proposal.speaker -%}
      <p>
        <em>This is a proposal requesting for someone to speak on this topic.
        If you’d like to speak, leave a comment.</em>
      </p>
    {%- endif -%}

    <h2>Objective</h2>
    {{ proposal.objective_html|safe }}
    <h2>Description</h2>
    {{ proposal.description_html|safe }}
    {% if proposal.requirements -%}
      <h2>Requirements</h2>
      {{ proposal.requirements_html|safe }}
    {%- endif %}
    {% if proposal.bio -%}
      <h2>Speaker bio</h2>
      {{ proposal.bio_html|safe }}
    {%- endif %}
{% if proposal.slides or proposal.links %}
  </div>
  <div class="section">
{% endif %}
    {% if proposal.slides %}
      <h2 id="slides">Slides</h2>
      <p>
        <div class="embed-container">
          <a id="slides-link" href="{{ proposal.slides }}">{{ proposal.slides }}</a>
        </div>
      </p>
    {% endif %}
    {% if proposal.links %}
      <h2 id="links">Links</h2>
        <ul id="links-list">
          {% for link in links -%}
            <li>{{ link }}</li>
          {% endfor %}
        </ul>
    {% endif %}
  </div>
  <div class="section">
    <h2 id="comments">Comments</h2>
    {% if comments %}
      <ul class="comments">
        {{ commenttree(comments, proposal, g.user, request.base_url) }}
      </ul>
    {% endif %}
    {% if not g.user -%}
      <p>
        <a href="{{ url_for('login') }}">Login with Twitter or Google to leave a comment &rarr;</a>
      </p>
    {% else -%}
      <p id="toplevel-comment" class="hidden">
        <a href="#">Post a comment &rarr;</a>
      </p>
      <form method="POST" id="newcomment">
        <div class="hidden">
          <input type="hidden" name="form.id" value="newcomment"/>
          {{ commentform.hidden_tag() }}
          {{ commentform.parent_id() }}
          {{ commentform.comment_edit_id() }}
        </div>
        <p>
          {{ renderfield_bs3(commentform.message) }}
        </p>
        <p>
          <input id="comment-submit" class="btn" type="submit" value="Post comment"/>
        </p>
      </form>
      <form method="POST" id="delcomment" class="hidden">
        <div class="hidden">
          <input type="hidden" name="form.id" value="delcomment"/>
          {{ delcommentform.hidden_tag() }}
          {{ delcommentform.comment_id() }}
        </div>
        <p>
          Really delete this comment?
          <input id="comment-delete-submit" class="btn btn-danger" type="submit" value="Delete"/>
          or <a id="comment-delete-cancel" class="btn" href="#">cancel</a>
        </p>
      </form>
    {% endif %}
  </div>
</div>
</div>

<div class="col-md-1 col-sm-1 col-xs-6 col-sm-pull-10 col-md-pull-10">
  <div class="leftear">
    {%- if proposal.getprev() -%}
      <a href="{{ url_for('prevsession', name=space.name, slug=proposal.urlname) }}" title="Previous"><i class="icon-chevron-left"></i></a>
    {%- else -%}
      <i class="icon-chevron-left"></i>
    {%- endif -%}
  </div>
</div>

<div class="col-md-1 col-sm-1 col-xs-6">
  <div class="rightear">
    {%- if proposal.getnext() -%}
      <a href="{{ url_for('nextsession', name=space.name, slug=proposal.urlname) }}" title="Next"><i class="icon-chevron-right"></i></a>
    {%- else -%}
      <i class="icon-chevron-right"></i>
    {%- endif -%}
  </div>
</div>


{% endblock %}

{% block footerscripts %}
<script type="text/javascript">
  $(function() {
    commentsInit("{{ request.base_url }}"); // {# FIXME: Potential vulnerability if this isn't JS-encoded #}
    {%- if proposal.slides %}
      $("#slides-link").oembed();
    {%- endif %}
    {%- if proposal.links %}
      $("#links-list a").oembed();
    {%- endif %}
  });
</script>
<script type="text/javascript" src="//apis.google.com/js/plusone.js"></script>
<script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
{% endblock %}
