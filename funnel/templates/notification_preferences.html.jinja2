{% extends "layout.html.jinja2" %}
{% from "baseframe/mui/forms.html.jinja2" import rendersubmit, ajaxform %}
{% from "baseframe/components.html.jinja2" import faicon %}
{%- from "macros.html.jinja2" import account_tabs, useravatar %}

{% block title %}{% trans %}My account{% endtrans %}{% endblock %}

{% block bodytag %}
  {%- if not config['LEGACY'] -%}
    <body class="mui--bg-primary hg-app tabs-navbar">
  {%- else %}
    <body class="mui--bg-primary">
  {%- endif %}
{% endblock %}

{% block headline -%}
  <div class="tabs-wrapper tabs-wrapper--sticky">
    <div class="mui-container">
      <div class="grid">
        <div class="grid__col-12">
          {{ account_tabs(active_tab='notification_preferences') }}
        </div>
      </div>
    </div>
  </div>
{%- endblock %}

{% block basecontent %}
  <div class="mui-container tab-content">
    <div class="grid">
      <div class="grid__col-xs-12">
        {% for transport in transports %}
          <p class="mui--text-title mui--text-capitalize">{{ transport }}</p>
          {% for key, preference in preferences.items() %}
            <div class="card">
              <div class="card__header">
                <p class="mui--text-subhead mui--text-bold zero-bottom-margin">{{ preference.title }}</p>
              </div>
              <div class="card__body">
                {% for type in preference.types %}
                  <div class="mui--clearfix">
                    <p class="mui--pull-left">{{ type.description }}</p>
                    <form method="POST" class="js-autosubmit-form">
                      {{ csrf_form.hidden_tag() }}
                      <input type="hidden" name="notification_type" value="{{ type.notification_type }}">
                      <input type="hidden" name="transport" value="{{ transport }}">
                      <label class="switch mui--pull-right" for="{{type.notification_type}}-{{transport}}">
                        <input type="checkbox" name="enabled" {%- if type.preferences[transport] %}checked{%- endif %} id="{{type.notification_type}}-{{transport}}" class="js-toggle-switch"/>
                        <div class="slider round"></div>
                      </label>
                    </form>
                  </div>
                {% else %}
                  <p class="mui--pull-left">{% trans %}{% endtrans %}</p>
                {%- endfor -%}
              </div>
            </div>
          {%- endfor -%}
        {%- endfor -%}
      </div>
    </div>
  </div>
{% endblock %}

{% block footerscripts %}
  <script type="text/javascript">
    $(function() {
      $('.js-toggle-switch').on('change', function(){
        console.log('changed');
        var checkbox = $(this);
        $.ajax({
          type: 'POST',
          url: {{ url_for('set_notification_preference')|tojson }},
          data: $(this).parents('.js-autosubmit-form').serializeArray(),
          dataType: 'json',
          timeout: 15000,
          success: function (remoteData) {
            console.log('remoteData', remoteData)
          },
          error: function (response) {
            console.log('response', response)
            var errorMsg = '';
            if (response.readyState === 4) {
              if (response.status === 500) {
                errorMsg ='Internal Server Error. Please reload and try again.';
              } else {
                errorMsg = JSON.parse(response.responseText).error_description;
              }
            } else {
              errorMsg = 'Unable to connect. Please reload and try again.';
            }
            window.toastr.error(errorMsg);
          },
        });
      });
    });
  </script>
{% endblock %}
