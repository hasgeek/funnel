{% extends "layout.html.jinja2" %}
{%- from "macros.html.jinja2" import rsvpform, rsvpscript, project_header, admin_panel %}
{% block title %}{{ project.title }}{% endblock %}
{% block description %}{{ project.title }} &ndash; {{ project.tagline }}{% endblock %}

{%- block layoutheaders %}
  {% assets "css_leaflet" -%}
    <link rel="stylesheet" type="text/css" href="{{ ASSET_URL }}" />
  {%- endassets -%}
{% endblock %}

{% block bodytag %}<body class="mui--bg-primary no-sticky-header">{% endblock %}

{%- macro page_btns(project) %}
  <ul class="mui-list--inline">
    {%- if project.boxoffice_data %}
      <li class="cta">
        <a href="#participate" class="mui-btn mui-btn--raised mui-btn--primary smooth-scroll" title="Participate" data-action="Participate(header)">{% trans %}Participate{% endtrans %}</a>
      </li>
    {%- elif project.buy_tickets_url %}
      <li class="cta">
        <a href="{{ project.buy_tickets_url }}" class="mui-btn mui-btn--raised mui-btn--primary" target="_blank" title="Participate" data-action="Participate(header)">{% trans %}Participate{% endtrans %}</a>
      </li>
    {%- elif project.allow_rsvp %}
      <li class="cta">
        <a href="#participate" class="mui-btn mui-btn--raised mui-btn--primary smooth-scroll" target="_blank" title="Participate" data-action="Participate(header)">{% trans %}Participate{% endtrans %}</a>
      </li>
    {%- endif %}
    {% if project.state.SUBMISSIONS -%}
      <li class="{% if not project.state.HAS_SESSIONS %}cta{%- endif %}">
        <a class="mui-btn mui-btn--raised mui-btn--accent" href="{{ project.url_for('new_proposal') }}" title="Propose a session" data-action="Propose a session(header)">{% trans %}Propose a session{% endtrans %}</a>
      </li>
    {% endif %}
    {%- if project.state.HAS_SESSIONS %}
      <li class="{% if project.state.SUBMISSIONS -%}float-btn{% else %}cta{% endif %}">
        <a href="{{ project.url_for('schedule') }}" class="mui-btn mui-btn--raised" title="View Schedule" data-action="View Schedule(header)">{% trans %}View Schedule{% endtrans %}</a>
      </li>
    {% endif %}
  </ul>
{%- endmacro %}

{% block headline %}
  {{ project_header(project, page_btns=page_btns(project)) }}
{% endblock %}

{% block contentwrapper %}
  <div class="grid details-section">
    <div class="grid__col-xs-12 grid__col-md-5 grid__col-lg-4">
      {%- if project.current_roles.admin or current_auth.permissions.checkin_event %}
        {{ admin_panel(project, transition_form) }}
      {% endif %}
    </div>

    <div class="grid__col-xs-12 grid__col-md-7 grid__col-lg-8" id="about">
      <h2 class="mui--text-display1 mui--text-left project-section__headline">About</h2>
      <div class="project-section__description">{{ project.description|safe }}</div>
      {%- if project.subprojects %}
        <hr class="mui-divider">
        <ul class="grid">
          {% for subproject in project.subprojects %}
            <li class="grid__col-12 grid__col-xs-12 grid__col-sm-6 grid__col-lg-4">
              <div class="grid__cell">
                <a href="{{ subproject.url_for() }}" class="clickable-card">
                  <div class="card">
                    <div class="card__title">
                      <h3 class="mui--text-title card__title__heading">{{ subproject.title }}</h3>
                      <h4 class="mui--text-subhead card__title__heading">{{ subproject.datelocation }}</h4>
                    </div>
                    {% if project.tagline %}
                      <div class="card__body">
                        <p>{{ subproject.tagline }}</p>
                      </div>
                    {% endif %}
                  </div>
                </a>
              </div>
            </li>
          {%- endfor -%}
        </ul>
      {%- endif %}
    </div>
  </div>

  {% if project.instructions -%}
  <div class="grid project-section" id="call-for-proposal">
    <div class="grid__col-xs-12 grid__col-md-7 grid__col-lg-8">
      <h2 class="mui--text-display1 mui--text-left project-section__headline">Call for proposals</h2>
      <div class="project-section__instructions">{{ project.instructions|safe }}</div>
      <p class="mui--text-left">
      {% if project.state.SUBMISSIONS -%}
        <a class="mui-btn mui-btn--raised mui-btn--primary mui--hidden-xs mui--hidden-sm mui--hidden-md" href="{{ project.url_for('new_proposal') }}" title="Propose a session" data-action="Propose a session(page)">{% trans %}Propose a session{% endtrans %}</a>
      {%- endif %}
      </p>
    </div>
  </div>
  {%- endif %}

  {% if project.featured_sessions  %}
  <div class="project-section" id="talks">
    <div class="grid">
      <div class="grid__col-xs-12">
        <h2 class="mui--text-display1 mui--text-left project-section__headline">Talks</h2>
      </div>
    </div>
    <ul class="grid">
      {% for session in project.featured_sessions %}
        <li class="grid__col-12 grid__col-xs-12 grid__col-sm-6 grid__col-lg-4">
          <div class="grid__cell">
            {% if session.proposal %}<a href="{{ session.proposal.url_for() }}" class="clickable-card" title="{{ session.title }}">{%- endif %}
              <div class="card">
                {% if session.banner_image_url %}
                  <div class="card__image-wrapper session-image">
                    <img class="card__image" src="{{ session.banner_image_url }}" alt="{{ session.title }}"/>
                  </div>
                  <div class="card__title">
                    <h3 class="mui--text-title card__title__heading"><b>{{ session.title }}</b></h3>
                    {% if session.speaker %}
                      <h4 class="mui--text-subhead card__title__heading">by {{ session.speaker }}</h4>
                    {% endif %}
                  </div>
                {% else %}
                  <div class="card__header">
                    <div class="card__header__title">
                      <h3 class="mui--text-title card__title__heading"><b>{{ session.title }}</b></h3>
                      {% if session.speaker %}
                        <h4 class="mui--text-subhead card__title__heading">by {{ session.speaker }}</h4>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}

                {% if session.description %}
                  <div class="card__body mui--text-body2 truncate">
                    <div>{{ session.description|safe }}</div>
                  </div>
                {% endif %}
              </div>
            {% if session.proposal %}</a>{%- endif %}
          </div>
        </li>
      {%- endfor -%}
    </ul>
    <div class="grid">
      <div class="grid__col-xs-12">
        <p class="mui--text-left">
        {%- if project.state.HAS_SESSIONS %}
          <a class="mui-btn mui-btn--raised mui-btn--accent" href="{{ project.url_for('schedule') }}" data-action="View schedule(page)">{% trans %}View Schedule{% endtrans %}</a>
        {%- endif %}
        </p>
      </div>
    </div>
  </div>
  {%- endif %}

  {% if project.boxoffice_data or project.allow_rsvp -%}
  <div class="grid project-section" id="participate">
    <div class="grid__col-xs-12">
      {% if project.boxoffice_data -%}
        <h2 class="mui--text-display1 mui--text-left project-section__headline">Tickets</h2>
        <div id="boxoffice-widget"><p class="mui--text-body1">Loading...</p></div>
      {%- endif %}
      {% if project.allow_rsvp -%}
        <h2 class="mui--text-display1 mui--text-left project-section__headline">{% trans %}Attending this event?{% endtrans %}</h2>
        {%- if g.user %}
          {{ rsvpform(project, rsvp_form) }}
        {%- else %}
          <p>
            <a href="{{ url_for('login') }}" class='mui-btn mui-btn--raised mui-btn--primary' data-action="Login to rsvp">{% trans %}Login to RSVP{% endtrans %}</a>
          </p>
        {%- endif %}
        {% if project.current_roles.admin or current_auth.permissions.view_rsvps %}
          <a href="{{ project.url_for('rsvp_list') }}">See RSVP list</a>
        {% endif %}
      {%- endif %}
    </div>
  </div>
  {%- endif %}

  {% if project.hasjob_embed_url -%}
  <div class="grid project-section" id="related-jobs">
    <div class="grid__col-xs-12">
      <h2 class="mui--text-display1 mui--text-left project-section__headline">Related jobs</h2>
      <div class="hasjob-embed" data-href="{{ project.hasjob_embed_url }}" {% if project.hasjob_embed_limit -%}data-jobpost-limit="{{ project.hasjob_embed_limit }}"{%- else %}data-jobpost-limit="8"{%- endif %}></div>
      <script src="{{ config['HASJOB_SERVER']|url_join('embed.js') }}" type="text/javascript"></script>
    </div>
  </div>
  {%- endif %}

  {%- if project.primary_venue -%}
  <div class="grid project-section" id="venue">
    <div class="grid__col-xs-12">
      <h2 class="mui--text-display1 mui--text-left project-section__headline">Venue</h2>
      <p class="mui--text-body1">{{ project.primary_venue.title }}<br>{{ project.primary_venue.address1 }}<br>{{ project.primary_venue.address2 }}<br>{{ project.primary_venue.city }}, {{ project.primary_venue.state }} {{ project.primary_venue.postcode }}, {{ project.primary_venue.country }}</p>
      {%- if project.primary_venue.latitude and project.primary_venue.longitude  -%}
        <div id="venue-map" class="project-section__map" data-label="{{ project.primary_venue.title }}" data-markerlat="{{ project.primary_venue.latitude }}" data-markerlng="{{ project.primary_venue.longitude }}"><h2>Loading...</h2></div>
      {%- endif %}
    </div>
  </div>
  {%- endif %}
{% endblock %}

{% block footerscripts %}
  {% assets "js_jquerysuccinct" -%}
    <script type="text/javascript" src="{{ ASSET_URL }}"></script>
  {%- endassets -%}
  {% assets "js_leaflet" -%}
    <script type="text/javascript" src="{{ ASSET_URL }}"></script>
  {%- endassets -%}
  {{ rsvpscript() }}
  <script type="text/javascript">
    $(function() {
      {% if project.boxoffice_data -%}
        window.Talkfunnel.TicketWidget.init({
          // TODO: Get url from config
          boxofficeUrl: {{ config['BOXOFFICE_SERVER']|tojson }},
          widgetElem: "#boxoffice-widget",
          org: {{ project.boxoffice_data.org|tojson }},
          itemCollectionId: {{ project.boxoffice_data.item_collection_id|tojson }},
          itemCollectionTitle: {{ project.title|tojson }}
        });
      {%- endif %}

      {%- if project.primary_venue.latitude and project.primary_venue.longitude -%}
        window.Talkfunnel.EmbedMap.init({
          mapElem: "#venue-map"
        });
      {%- endif %}

      var tableSearch = new window.TableSearch('proposals-table');
      $('input#search').keyup(function(e){
        if($('.collapsible__body').css('display') == 'none') {
          $('.collapsible__header').click();
        }
        $('#proposals-table tbody tr').addClass('mui--hide');
        var hits = tableSearch.searchRows($(this).val());
        $(hits.join(",")).removeClass('mui--hide');
      });

      $('.truncate').succinct({
        size: 200
      });

    });
  </script>
{% endblock %}
