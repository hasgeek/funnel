{% extends "layout.html" %}
{% from "macros.html" import rsvpform, rsvpscript %}
{% from "baseframe/forms.html" import renderfield %}
{% block title %}{{ space.title }}{% endblock %}
{% block pageheaders %}
{% endblock %}
{% block headline %}
  <div class="page-header">
    {#<h3><a href="{{ space.profile.url_for() }}">{{ space.profile.title }}</a> &nbsp;<i class="fa fa-angle-right"></i></h3>#}
    <h1>{{ space.title }}</h1>
  </div>
{% endblock %}

{% block content %}
  <div class="row">
    <div class="col-lg-3 col-md-6 col-sm-4 col-xs-6">
      <h3>{{event.title}}</h3>
    </div>
    <div class='col-lg-9 col-md-6 col-sm-8 col-xs-6'>
      <h3 class='pull-right'>
        Checked In: <span class="js-totalcheckin"></span> |
        Total: <span class="js-total"></span>
      </h3>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-3 col-sm-4 col-xs-6">
      <form class="search-participant">
          <input autofocus class="form-control search-query" id="search" type="text" name="key" value="" placeholder="Search"/>
      </form>
    </div>
    <div class="col-lg-9 col-xs-12">
      <ul class="list-inline status-btn-list">
        <li>
          <a href={{ url_for('event_edit', profile=space.profile.name, space=space.name, name=event.name) }} class='btn btn-primary'>Edit event title</a>
        </li>
        <li><a href={{ url_for('event_badges', profile=space.profile.name, space=space.name, name=event.name) }} target="_blank" class='btn btn-info'>Badges to be printed</a></li>
        <li><a href={{ url_for('event_badges', profile=space.profile.name, space=space.name, name=event.name, badge_printed='t') }} target="_blank" class='btn btn-success'>Badges printed</a></li>
        <li class="badge-print-status-btn">
          <form method="POST" id="badge_form" class="form-inline">
              {{ badge_form.hidden_tag() }}
              {{ renderfield(badge_form.badge_printed, style='wide', nolabel=true) }}
            <input id="badge-form-submit" class="btn btn-danger" type="submit" value="{% trans %}Update badges{% endtrans %}"/>
          </form>
        </li>
      </ul>
    </div>
  </div>
  <table class="table footable" id='participants-table'>
    <thead>
      <tr>
        <th>Name</th>
        <th data-hide="phone">Email</th>
        <th data-hide="tablet, phone">Company</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="participants-table-content">
      {% raw %}
      <script id='participant-row' type='text/ractive'>
      {{#each participants}}
        <tr id="p-{{ pid }}">
          <td class='js-searchable'>{{ fullname }}</td>
          <td class='js-searchable'>{{ email }}</td>
          <td class='js-searchable'>{{ company }}</td>
          <td>
            <ul class="list-inline status-btn-list">
              <li>
                <a href="{{ showbadge_url }}" {{#badge_printed}} class="btn btn-xs btn-success" {{/badge_printed}} {{^badge_printed}} class="btn btn-xs btn-info" {{/badge_printed}} target="_blank">Show badge</a>
              </li>
              <li>
                <a href="{{ edit_url }}" class="btn btn-xs btn-default" target="_blank">Edit</a>
              </li>
              <li>
                <form action="{{ checkin_url }}" method='POST' class='checkin_form form-inline' id="{{ pid }}">
                  <div style="display:none;">
                    <input id="csrf_token" name="csrf_token" value="{{ getCsrfToken() }}" type="hidden">
                  </div>
                  <input type="hidden" name="pid" value="{{ pid }}">
                  {{#checked_in}}
                    <input type="hidden" name="checkin" value="f">
                    <input value="Cancel Check-in" class="btn btn-xs js-cancel-checkin" type="submit">
                  {{/checked_in}}
                  {{^checked_in}}
                    <input type="hidden" name="checkin" value="t">
                    <input value="Check-in" class="btn btn-xs js-checkin" type="submit">
                  {{/checked_in}}
                  <i class="fa fa-spinner fa-pulse js-loader"></i>
                  <i class="fa fa-close js-loader js-abort"></i>
                </form>
              </li>
            </ul>
          </td>
        </tr>
      {{/each}}
      </script>
      {% endraw %}
    </tbody>
  </table>
{% endblock %}
{% block footerscripts %}
<script>
  if (Modernizr.localstorage) {
    //If there is no network, display a confirmation dialog when user closes/reloades the page
    window.onbeforeunload = function() {
      if(!navigator.onLine) {
        return 'There is no network!';
      }
    };
  }

  $(document).ready(function() {

    // To disable debug mode
    Ractive.DEBUG = false;

    var participantTableContent = new Ractive({
      el: '#participants-table-content',
      template: '#participant-row',
      data: {
        participants: '',
        getCsrfToken: function() {
          return $('meta[name="csrf-token"]').attr('content');
        }
      }
    });

    if (Modernizr.localstorage) {
      var checkinQ = new window.Talkfunnel.Queue("checkin-queue");
      var cancelcheckinQ = new window.Talkfunnel.Queue("cancelcheckin-queue");
    }

    //updateQueue: If participant in "checkin-queue" has already been checked-in then it is removed from checkin queue
    var updateQueue = function(queue, participants) {
      var participantIDs = queue.readAll();
      if(participantIDs) {
        participantIDs.forEach(function(participantID) {
          if(queue.queueName === "checkin-queue") {
            if(participants[participantID].checked_in) {
              //Participant has been checked-in so remove from 'checkin-queue' 
              queue.dequeue(participantID);
            }
            else {
              $('#' + participantID).find('.js-loader').show();
            }
          }
          else {
            if(!participants[participantID].checked_in) {
              //Participant's check-in has been cancelled so remove from 'cancelcheckin-queue' 
              queue.dequeue(participantID);
            }
            else {
              $('#' + participantID).find('.js-loader').show();
            }
          }
        });
      }
    };

    var updateParticipantList = function() {
      $.ajax({
        type: 'GET',
        url:  "{{ url_for('event_participants_json', profile=space.profile.name, space=space.name, name=event.name) }}",
        timeout: 5000,
        dataType: 'jsonp',
        success: function(data) {
          participantTableContent.set('participants', data.participants).then(function() {
            if (Modernizr.localstorage) {
              $('.js-loader').hide();
              var participants = tohashMap(data.participants, "pid");
              updateQueue(checkinQ, participants);
              updateQueue(cancelcheckinQ, participants);
              $('.js-total').text(data.total_participants);
              $('.js-totalcheckin').text(data.total_checkedin);
            }
          });
          $('.footable').trigger('footable_redraw');
        }
      });
    };

    var postCheckinStatus = function(participantIDs, action) {
      var formValues = $.param({"pid":participantIDs}, true);
      if(action) {
        formValues += "&checkin=t";
      }
      formValues += "&csrf_token=" + $("meta[name='csrf-token']").attr('content');
      $.ajax({
        type: 'POST',
        url:  "{{ url_for('event_checkin', profile=space.profile.name, space=space.name, name=event.name) }}",
        data : formValues,
        timeout: 5000,
        dataType: "json",
        success: function(data) {
          if(data.checked_in) {
            data.participant_ids.forEach(function(participant_id) {
              checkinQ.dequeue(participant_id);
            });
          }
          else {
            data.participant_ids.forEach(function(participant_id) {
              cancelcheckinQ.dequeue(participant_id);
            });
          }
        }
      });
    };

    var processQueues = function() {
      //Read all participants from 'checkin-queue' and post check-in to server
      var participantIDs = checkinQ.readAll();
      if(participantIDs) {
        postCheckinStatus(participantIDs, true);
      }
      //Read all participants from 'cancelcheckin-queue' and post cancel check-in to server
      participantIDs = cancelcheckinQ.readAll();
      if(participantIDs) {
        postCheckinStatus(participantIDs, false);
      }
    };

    /*
      Check-in scenarios:
      1. A participant is checked-in & Internet is available. Also verify for cancel check-in and multiple participants check-in.
      2. A participant is checked-in & Internet is down.
      3. Abort a participant's check-in(A wrong particpant was checked in so cancel check-in immediately using abort) when Internet is available.
      4. Abort a participant's check-in when Internet is down.
      5. There are two check-in counters & both counters have internet: They have checked-in different participants. Verify both counters have the recent check-in status of participants.
      6. There are two check-in counters & both counter's internet is down: They have checked-in different participants. Verify both counters have the recent check-in status of participants, once internet is up.
      7. There are two check-in counters & both counters have internet: They checked-in few same participants. Verify both counters have the recent check-in status of participants.
      8. There are two check-in counters & both counter's internet is down: They checked-in few same participants. Verify both counters have the recent check-in status of participants, once internet is up.
      8. There are two check-in counters & one counters has internet and the other counter doesn't: They have checked-in different participants. Verify both counters have the recent check-in status of participants, once internet is up.
      9. There are two check-in counters & one counters has internet and the other counter doesn't: They have checked-in few same participants. Verify both counters have the recent check-in status of participants, once internet is up.
    */

    //Get the list of participants from server
    updateParticipantList();

    //If localStorage is available, register event handlers for check-in, cancel-checkin and abort
    if (Modernizr.localstorage) {
      $('#participants-table-content').on('submit', '.checkin_form', function(event) {
        event.preventDefault();
        var formValues = {};
        $(this).serializeArray().map(function(obj) {
          formValues[obj.name] = obj.value;
        });
        if(formValues["checkin"] === "t") {
          checkinQ.enqueue(formValues["pid"]);
        }
        else {
          cancelcheckinQ.enqueue(formValues["pid"]);
        }
        $(this).find('.js-loader').show();
      });

      $('#participants-table-content').on('click', '.js-abort', function(event) {
        event.preventDefault();
        var participantID = $(this).siblings('input[name="pid"]').val();
        var checkinStatus = $(this).siblings('input[name="checkin"]').val();

        if(checkinStatus === "t") {
          // Case 1: On abort, participantID is removed from "checkin-queue" if present.
          // Case 2: On abort, if participantID is not present in the "checkin-queue" it implies check-in request has been sent to server, so check-in has to be cancelled, hence add it to "cancelcheckin-queue".
          if(!checkinQ.dequeue(participantID)) {
            cancelcheckinQ.enqueue(participantID);
          }
        }
        else{
          if(!cancelcheckinQ.dequeue(participantID)) {
            checkinQ.enqueue(participantID);
          }
        }
        //Hide loader and abort
        $('#' + participantID).find('.js-loader').hide();
      });

      //Read 'checkin-queue' and 'cancelcheckin-queue' every 8 second and post check-in status to server
      setInterval(processQueues, 8000);

      //Get participants data from server every 1 min
      setInterval(updateParticipantList, 60000);
    }

    $('#badge_form').on("submit", function(){
       if ($('#badge_form select.field-badge_printed').val() === "") {
        return false;
       }
       return window.confirm("Are you sure? Selected action will apply to all listed participants.");
    });

    var tableSearch = new window.TableSearch('participants-table');
    $('input#search').keyup(function(e){
      $('#participants-table tbody tr').addClass('hidden');
      var hits = tableSearch.searchRows($(this).val());
      $(hits.join(",")).removeClass('hidden');
    });
    
    $('.footable').footable({
      breakpoints: {
        phone: 600,
        tablet: 768,
      }
    });
  });
</script>
{% endblock %}