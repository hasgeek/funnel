{% from "baseframe/forms.html.jinja2" import renderform %}

{% macro calendarwidget(calendar, compact=true) %}
  <div class="card__calendar {% if compact %} card__calendar--compact {% endif %}" aria-hidden="true">
    <div class="calendar">
      {% set event = namespace(month='', year='') %}
      {% for week in calendar.weeks|sort(attribute='year') %}
        {% for date in week.dates %}
          {% if date.count > 0 and not event.month %}
            {% set event.month = week.month  %}
            {% set event.year = week.year  %}
          {% endif %}
        {% endfor %}
      {% endfor %}
      <p class="calendar__month-name">{{ event.month }} {{ event.year }}&nbsp;<span class="calendar__counting" data-today="{{ calendar.today }}"></span></p>
      <div class="calendar__weekdays mui--bg-accent {% if calendar.weeks|length > 1 %} calendar__weekdays--rows {% endif %}">
        {% for week in calendar.weeks|sort(attribute='year') %}
          <div class="calendar__weekdays__dates">
            {% for date in week.dates %}
              <p class="calendar__weekdays__dates__date {% if date.count > 0 %}calendar__weekdays__dates__date--active {% elif date.isoformat == calendar.today %} calendar__weekdays__dates__date--today{% endif %} {% if date.day_start_at %} calendar__weekdays__dates__date--showtime{% endif %}" {% if date.count > 0 %} data-event-date="{{ date.isoformat }}" {% endif %}>
                <span class="calendar__weekdays__dates__date__day">{{ date.day }}</span>
                <span class="calendar__weekdays__dates__date__name">{{ calendar.days[loop.index-1] }}</span>
                {% if date.day_start_at %}<span class="calendar__weekdays__dates__time">{{ date.day_start_at }} - {{ date.day_end_at }}</span>{% endif %}
              </p>
            {% endfor %}
            {% if calendar.weeks|length > 1 %}
              <p class="calendar__weekdays__dates__date calendar__weekdays__dates__icon">
                {% assets "fa5-sprite" %}<svg class="fa5-icon calendar__weekdays__dates__icon__next" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#chevron-right"></use></svg>{% endassets %}
              </p>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
{% endmacro %}

{% macro saveprojectform(project, form, formid='save-form') %}
  <form id={{formid}} class="js-save-form" action="{{ project.url_for('save') }}" method="POST">
    {{ form.hidden_tag() }}
    <p class="no-jshidden zero-bottom-margin">
      {%- if current_auth.is_anonymous %}
        <a class="mui-btn mui-btn--nostyle"  href="{{ url_for('login') }}" data-action="Login to save project">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5-icon--title fa5--align-baseline" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#bookmark"></use></svg>{% endassets %}</a>
      {%- else %}
        <input type="hidden" name="save" value="">
        <button type="submit" value="true" class="mui-btn mui-btn--nostyle animate-btn {% if not project.is_saved_by(current_auth.user) %} animate-btn--show {% endif %}" data-action="Save {{project.title}}" onclick="this.form.save.value=this.value">
          {% assets "fa5-sprite" %}<svg class="fa5-icon fa5--align-baseline" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#bookmark"></use></svg>{% endassets %}
        </button>
        <button type="submit" value="false" class="mui-btn mui-btn--nostyle animate-btn animate-btn--saved{% if project.is_saved_by(current_auth.user) %} animate-btn--show {% endif %}" data-action="Unsave {{project.title}}" onclick="this.form.save.value=this.value">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5--align-baseline bookmarked" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#bookmark-solid"></use></svg>{% endassets %}</button>
      {%- endif %}
    </p>
  </form>
{% endmacro %}

{% macro project_header(project, project_save_form, class='', current_page='project') %}
  <div class="mui-container project-banner {% if class %}{{ class }}{% endif %}">
    <div class="grid">
      <div class="grid__col-sm-12">
        <div class="profile-details">
          {%- if project.profile.logo_url.url %}
            <a href="{{project.profile.url_for()}}" class="profile-details__logo-wrapper" data-action="View {{ project.profile.title }}(project page)">
              <img class="profile-details__logo_wrapper__logo" src="{{ project.profile.logo_url }}" alt="{{ project.profile.title }}"/>
            </a>
          {% endif %}
          <a href="{{project.profile.url_for()}}" class="mui--text-subhead mui--text-bold profile-details__text" data-cy="profile-link" data-action="View {{ project.profile.title }}(project page)">{{ project.profile.title }}</a>
        </div>
      </div>
      <div class="grid__col-sm-12 project-banner__headline">
        <h1 class="mui--text-display1 mui--text-bold">{{ project.title }}</h1>
        <p class="mui--text-headline mui--text-light zero-bottom-margin">{{ project.tagline }}</p>
      </div>
      {% if project.livestream_urls %}
        <div role="tabpanel" class="grid__col-sm-12 grid__col-md-8 livestream-box" id="livestream">
          <ul class="mui-tabs__bar project-banner__box" role="tablist">
            {%- for stream in project.livestream_urls %}
              <li role="presentation" {%- if loop.first %} class="mui--is-active"{% endif %}>
                <a role="tab" data-mui-toggle="tab" data-mui-controls="pane-justified-{{ loop.index }}">Livestream {{loop.index}}</a>
              </li>
            {%- endfor %}
          </ul>

          {%- for stream in project.livestream_urls %}
            <div role="tabpanel" class="mui-tabs__pane {%- if loop.first %} mui--is-active{% endif %}" id="pane-justified-{{ loop.index }}">
              <div class="project-banner__box">
                <div class="embed-video-wrapper js-embed-video" data-video-src="{{ stream }}">
                  <p class="video_txt">
                    {% assets "fa5-sprite" %}<svg class="fa5-icon fa5-icon--display1 fa5--align-baseline" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#video"></use></svg>{% endassets %}<br>
                    <a href="{{ stream }}" target="_blank" class="mui--text-title">{% trans %}Preview video{% endtrans %}</a>
                  </p>
                </div>
              </div>
            </div>
          {%- endfor %}
        </div>
      {% else %}
        <div class="grid__col-sm-12 grid__col-md-8 project-banner__box">
          <div class="embed-video-wrapper">
            {% if project.banner_video_url.url %}
              {{ project.banner_video_url|safe }}
            {%- elif project.bg_image.url %}
              <img class="project-banner__box__image" src="{{ project.bg_image }}" alt="{{ project.title }}" data-cy="bg_image"/>
            {%- else %}
              <img class="project-banner__box__image" src="{{ url_for('static', filename='img/default-banner.png') }}"/>
            {% endif %}
          </div>
        </div>
      {% endif %}
      <div class="grid__col-md-4 project-details__box {% if project.livestream_urls %}project-details__box--topmargin{% endif %}">
        <div class="bookmark-icon  {% if not project.calendar_weeks_full.weeks %} bookmark-icon--height {% endif %}">{{ saveprojectform(project, project_save_form) }}</div>
        {% if project.schedule_state.PUBLISHED and project.calendar_weeks_full.weeks and project.calendar_weeks_full.weeks|length > 0 %}
          <div aria-label="{{ project.datelocation }}">
            {{ calendarwidget(project.calendar_weeks_full, compact=false) }}
          </div>
          <p class="add-calendar"><a href="{{ project.url_for('subscribe_schedule') }}" rel="modal:open">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5-icon--caption fa5--align-baseline" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#calendar-plus"></use></svg>{% endassets %}&nbsp;{% trans %}Add to calendar{% endtrans %}</a></p>
        {% endif %}
        <div class="project-details__box--ticketbox">
          <div class="project-banner__action">
            <div class="project-banner__action__social">
              <p class="mui--text-light zero-bottom-margin">{% trans %}Share this project{% endtrans %}</p>
              <a class="mui--text-headline mui--text-light" data-width="550" data-height="250" rel="noopener" target="_blank" href="https://twitter.com/share?url={{ project.url_for(_external=true) }}" aria-label="{% trans %}Tweet this{% endtrans %}" data-action="Tweet this(header)">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5-icon--headline mui--align-bottom" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#twitter-square"></use></svg>{% endassets %}</a>
              <a class="mui--text-headline mui--text-light" data-width="520" data-height="230" rel="noopener" target="_blank" href="http://www.facebook.com/sharer.php?s=100&p[url]={{ project.url_for(_external=true) }}" aria-label="{% trans %}Share on Facebook{% endtrans %}" data-action="Share on Facebook(header)">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5-icon--headline mui--align-bottom" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#facebook-square"></use></svg>{% endassets %}</a>
              <a class="mui--text-headline mui--text-light" href="mailto:?subject={{ project.title }}&amp;body={{ project.url_for(_external=true) }}" aria-label="{% trans %}Email this{% endtrans %}" data-action="Email this(header)">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5-icon--headline mui--align-bottom" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#envelope-square"></use></svg>{% endassets %}</a>
            </div>
          </div>
          <div class="mui--hidden-xs mui--hidden-sm">
            {%- if project.allow_rsvp or project.boxoffice_data and project.boxoffice_data.item_collection_id -%}
              <a href="{%- if current_page == 'project' -%}#tickets{%- else %}{{ project.url_for() }}#tickets{%- endif %}" class="mui-btn mui-btn--raised mui-btn--primary mui--d-block {% if current_page == 'project' %}js-smooth-scroll js-samepage{%- endif %}" data-action="Get tickets(header)" id="ticket-btn">{%- if project.boxoffice_data and project.boxoffice_data.item_collection_id %}{% trans %}Get tickets{% endtrans %}{% else %}{% trans %}Attend{% endtrans %}{% endif %}</a>
            {%- elif project.buy_tickets_url.url %}
              <a class="mui-btn mui-btn--raised mui-btn--primary mui--d-block" href="{{ project.buy_tickets_url }}" data-action="Buy Tickets(header)">
              {% if project.boxoffice_data and project.boxoffice_data.buy_btn_text -%}
                {{ project.boxoffice_data.buy_btn_text }}
              {% else %}
                {% trans %}Get tickets{% endtrans %}
              {% endif %}
              </a>
            {%- endif %}
          </div>
          {% if project.cfp_state.OPEN -%}
            <div class="propose propose--lessmargin">
              <a class="mui-btn mui-btn--raised mui--d-block propose__btn" href="{{ project.url_for('new_proposal') }}" data-action="Submit a session proposal(header)" data-cy="propose-a-session">{% trans %}Submit a session proposal{% endtrans %}</a>
              {% if project.cfp_end_at_localized -%}<p>{% assets "fa5-sprite" %}<svg class="fa5-icon fa5--align-baseline secondary-color-txt" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#info-circle"></use></svg>{% endassets %} <em class="mui--text-body1">{% trans date=project.cfp_end_at_localized.strftime('%d %B, %I:%M %p') %}Proposal submission closes on {{ date }}{% endtrans %}</em></p>{% endif %}
            </div>
          {%- elif project.cfp_state.UNAVAILABLE %}
            <div class="propose propose--lessmargin">
              <a class="mui-btn mui-btn--raised mui--d-block propose__btn propose__btn--strike" data-cy="Submit a session proposal" data-action="Propose a session(closed)">{% trans %}Submit a session proposal{% endtrans %}</a>
              <p class="mui--text-light mui--text-caption mui--text-center zero-bottom-margin">{% trans %}Submissions are closed for this project{% endtrans %}</p>
            </div>
          {%- endif %}
          {%- if project.primary_venue %}
            <p class="project-venue"><a class="mui--text-hyperlink mui--text-subhead {% if current_page == 'project' %}js-smooth-scroll{%- endif %}" href="{%- if current_page != 'project' -%}{{ project.url_for() }}{%- endif %}#venue" data-action="Venue(header)" data-action="Venue(header)">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5-title fa5--align-baseline" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#map-marker-alt"></use></svg>{% endassets %} <span>{{ project.primary_venue.title }}</span>{%- if project.primary_venue.city %}, <span>{{ project.primary_venue.city }}</span>{%- endif %}</a></p>
          {%- endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="sub-navbar-container sub-navbar-container--sticky mui--bg-accent {% if class %}{{ class }}{% endif %}">
    <nav class="sub-navbar mui-container" id="page-navbar">
      <a class="sub-navbar__item mui--text-subhead mui--text-light mui--hidden-xs mui--hidden-sm {% if current_page == 'project' %}js-smooth-scroll js-samepage{%- endif %}" href="{%- if current_page != 'project' -%}{{ project.url_for() }}{%- endif %}#about" data-action="About(navbar)" data-cy-navbar="about">{% trans %}About{% endtrans %}</a>
      {%- if project.allow_rsvp or project.boxoffice_data and project.boxoffice_data.item_collection_id -%}
        <div class="sub-navbar__item--wrapper" id="ticket-wrapper"><a href='#tickets' class="open-ticket-widget sub-navbar__item sub-navbar__item--primarybg mui--text-subhead mui--text-light mui--hidden-md mui--hidden-lg mui--hidden-xl" data-action="Tickets(navbar)" id="ticket-btn" data-cy-navbar="tickets">{%- if project.boxoffice_data and project.boxoffice_data.item_collection_id %}{% trans %}Get tickets{% endtrans %}{% else %}{% trans %}Attend{% endtrans %}{% endif %} <span class="sub-navbar__item__icon mui--pull-right">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5-icon--subhead fa5--align-baseline" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#chevron-right"></use></svg>{% endassets %}</span></a></div>
      {%- elif project.buy_tickets_url.url %}
        <div class="sub-navbar__item--wrapper" id="ticket-wrapper"><a class="sub-navbar__item sub-navbar__item--primarybg mui--text-subhead mui--text-light mui--hidden-md mui--hidden-lg mui--hidden-xl" href="{{ project.buy_tickets_url }}" data-action="Tickets(navbar)" id="ticket-btn"> {% if project.boxoffice_data and project.boxoffice_data.buy_btn_text -%}{{ project.boxoffice_data.buy_btn_text }}{% else %}{% trans %}Get tickets{% endtrans %}{% endif %} <span class="sub-navbar__item__icon mui--pull-right">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5-icon--subhead fa5--align-baseline" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#chevron-right"></use></svg>{% endassets %}</span></a></div>
      {%- endif %}
      {%- if project.featured_sessions %}
        <a class="sub-navbar__item mui--text-subhead mui--text-light {% if current_page == 'project' %}js-smooth-scroll js-samepage{%- endif %}" href="{%- if current_page != 'project' -%}{{ project.url_for() }}{%- endif %}#talks" data-action="Talks(navbar)" data-cy-navbar="talks">{% trans %}Talks{% endtrans %} <span class="sub-navbar__item__icon mui--pull-right">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5-icon--subhead fa5--align-baseline" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#chevron-right"></use></svg>{% endassets %}</span></a>
      {%- endif %}
      {%- if project.sessions_with_video.count() > 0 %}
        <a class="sub-navbar__item mui--text-subhead mui--text-light {% if current_page == 'videos' %}js-smooth-scroll js-samepage{%- endif %}" href="{%- if current_page != 'videos' -%}{{ project.url_for('session_videos') }}{%- endif %}#video" data-action="Video(navbar)" data-cy-navbar="video">{% trans %}Video{% endtrans %} <span class="sub-navbar__item__icon mui--pull-right">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5-icon--subhead fa5--align-baseline" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#chevron-right"></use></svg>{% endassets %}</span></a>
      {%- endif %}
      {%- if project.hasjob_embed_url.url -%}
        <a class="sub-navbar__item mui--text-subhead mui--text-light {% if current_page == 'project' %}js-smooth-scroll js-samepage{%- endif %}" href="{%- if current_page != 'project' -%}{{ project.url_for() }}{%- endif %}#related-jobs" data-action="Jobs(navbar)" data-cy-navbar="jobs">{% trans %}Jobs{% endtrans %} <span class="sub-navbar__item__icon mui--pull-right">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5-icon--subhead fa5--align-baseline" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#chevron-right"></use></svg>{% endassets %}</span></a>
      {%- endif %}
      {%- if project.primary_venue -%}
        <a class="sub-navbar__item mui--text-subhead mui--text-light {% if current_page == 'project' %}js-smooth-scroll js-samepage{%- endif %}" href="{%- if current_page != 'project' -%}{{ project.url_for() }}{%- endif %}#venue" data-action="Venue(navbar)" data-cy-navbar="venue">{% trans %}Venue{% endtrans %} <span class="sub-navbar__item__icon mui--pull-right">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5-icon--subhead fa5--align-baseline" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#chevron-right"></use></svg>{% endassets %}</span></a>
      {%- endif %}
      {%- if project.current_roles.admin or not project.cfp_state.NONE -%}
        <a class="sub-navbar__item mui--text-subhead mui--text-light {% if current_page == 'proposals' %}js-smooth-scroll js-samepage{%- endif %}" href="{%- if current_page != 'proposals' -%}{{ project.url_for('view_proposals') }}{%- endif %}#call-for-proposal" data-action="Proposals(navbar)" data-cy-navbar="proposals">{% trans %}Proposals{% endtrans %} <span class="sub-navbar__item__icon mui--pull-right">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5-icon--subhead fa5--align-baseline" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#chevron-right"></use></svg>{% endassets %}</span></a>
      {%- endif %}
      {%- if project.schedule_state.PUBLISHED %}
        <a class="sub-navbar__item mui--text-subhead mui--text-light {% if current_page == 'schedule' %}js-smooth-scroll js-samepage{%- endif %}" href="{%- if current_page != 'schedule' -%}{{ project.url_for('schedule') }}{%- else %}#schedule{%- endif %}" data-action="Schedule(navbar)" data-cy-navbar="schedule">{% trans %}Schedule{% endtrans %} <span class="sub-navbar__item__icon mui--pull-right">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5-icon--subhead fa5--align-baseline" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#chevron-right"></use></svg>{% endassets %}</span></a>
      {%- endif %}
      {%- if project.current_roles.admin or current_auth.permissions.checkin_event -%}
        <a class="sub-navbar__item mui--text-subhead mui--text-light {% if current_page == 'settings' %}js-smooth-scroll js-samepage{%- endif %}" href="{%- if current_page != 'settings' -%}{{ project.url_for('settings') }}{%- endif %}#admin-panel" data-action="Settings(navbar)" data-cy-navbar="settings">{% trans %}Settings{% endtrans %} <span class="sub-navbar__item__icon mui--pull-right">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5-icon--subhead fa5--align-baseline" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#chevron-right"></use></svg>{% endassets %}</span></a>
      {%- endif %}
    </nav>
  </div>
{% endmacro %}

{% macro embed_video_player(video) %}
  {% if video.video_source != 'raw' %}
    <iframe src="{{ video.embeddable_url }}" frameborder="0" allowfullscreen></iframe>
  {% else %}
    <p class="video_txt">
      {% assets "fa5-sprite" %}<svg class="fa5-icon fa5-icon--display1 fa5--align-baseline" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#video"></use></svg>{% endassets %}<br>
      <a href="{{ video.video_id }}" target="_blank" class="mui--text-title">{% trans %}Preview video{% endtrans %}</a>
    </p>
  {%- endif %}
{% endmacro %}

{% macro video_action_bar(video, proposal='', session='') %}
  {%- if video.video_source == 'youtube' -%}
    <p><a href="https://videoken.com" target="_blank" class="mui--text-caption details__box__control__link">Powered by VideoKen</a></p>
  {%- endif %}

  {%- if proposal and proposal.current_roles.owner %}
    <a class="details__box__control__link mui--text-subhead" href="{{ proposal.url_for('edit') }}#field-video" data-cy="edit-video" aria-label="{% trans %}Edit proposal video{% endtrans %}">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5--link fa5-icon--subhead" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#edit"></use></svg>{% endassets %}</a>
  {% elif session and session.project.current_roles.admin %}
    <a class="details__box__control__link mui--text-subhead" href="{{ session.url_for('edit') }}" data-cy="edit-video" aria-label="{% trans %}Edit session video{% endtrans %}">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5--link fa5-icon--subhead" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#edit"></use></svg>{% endassets %}</a>
  {%- endif %}

  {%- if proposal or session %}
    {%- if proposal %}
      {% set url, title = proposal.url_for(_external=true), proposal.title  %}
    {% else %}
      {% set url, title = session.url_for(_external=true), session.title %}
    {%- endif %}
    <div class="mui-dropdown">
      <a href="javascript:void(0)" class="details__box__control__link mui--text-subhead" data-mui-toggle="dropdown" data-action="Share dropdown">{% assets "fa5-sprite" %}<svg class="fa5-icon fa5-icon--subhead fa5--align-baseline" aria-hidden="true" role="img"><use xlink:href="{{ ASSET_URL }}#share-square"></use></svg>{% endassets %}</a>
      <ul class="mui-dropdown__menu mui-dropdown__menu--right">
        <li><a class="details__box__control__link mui--text-title" target="_blank" href="//twitter.com/share?url={{ url }}&amp;via=HasGeek&amp;text={{ title }}" data-url="{{ url }}" data-via="HasGeek" data-text="{{ title }}" data-action="Tweet video">Twitter</a></li>
        <li><a class="details__box__control__link mui--text-title" target="_blank" href="//www.facebook.com/sharer.php?u={{ url }}&amp;t={{ title }}" data-href="{{ url }}" data-action="Share video on facebook">Facebook</a></li>
        <li><a class="details__box__control__link mui--text-title" href="mailto:?subject={{ title }}&amp;body={{ url }}" data-action="Email video">Email</a></li>
      </ul>
    </div>
  {%- endif %}
{% endmacro %}
